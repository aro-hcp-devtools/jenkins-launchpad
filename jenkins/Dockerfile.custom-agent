FROM python:3.10-slim

# Install build dependencies and tools
RUN apt-get update && apt-get install -y \
    make \
    build-essential \
    curl \
    wget \
    gnupg2 \
    git \
    jq \
    openssl \
    libicu-dev \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install Azure CLI
RUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash

# Install Bicep CLI
RUN az bicep install

# Install AKS CLI
RUN az aks install-cli

# Install kubectl (latest stable version)
RUN KUBECTL_VERSION=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt) && \
    wget -q https://storage.googleapis.com/kubernetes-release/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl -O /usr/local/bin/kubectl && \
    chmod +x /usr/local/bin/kubectl

# Install Helm (latest stable version)
RUN HELM_VERSION=$(curl -s https://api.github.com/repos/helm/helm/releases/latest | jq -r '.tag_name') && \
    wget -q https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz && \
    tar -xzf helm-${HELM_VERSION}-linux-amd64.tar.gz && \
    mv linux-amd64/helm /usr/local/bin/helm && \
    rm -rf helm-${HELM_VERSION}-linux-amd64.tar.gz linux-amd64/ && \
    chmod +x /usr/local/bin/helm

# Install yq (latest version)
RUN YQ_VERSION=$(curl -s https://api.github.com/repos/mikefarah/yq/releases/latest | jq -r '.tag_name') && \
    wget -q https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 -O /usr/local/bin/yq && \
    chmod +x /usr/local/bin/yq

# Install Go 1.24.6
RUN wget -q https://go.dev/dl/go1.24.6.linux-amd64.tar.gz \
    && tar -C /usr/local -xzf go1.24.6.linux-amd64.tar.gz \
    && rm go1.24.6.linux-amd64.tar.gz

# Set Go environment variables
ENV PATH=$PATH:/usr/local/go/bin
ENV GOPATH=/go
ENV GOBIN=/go/bin

# Install Python dependencies
RUN pip install PyYAML

# Set working directory
WORKDIR /workspace

# Create go workspace
RUN mkdir -p /go/bin /go/src /go/pkg

CMD ["/bin/bash"]
